# Copyright 2024 Sam Windell
# SPDX-License-Identifier: GPL-3.0-or-later

name: CI

on:
  workflow_dispatch:
  push:
  pull_request:

jobs:
  compile:
    name: Compile
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Nix Develop Action
        uses: nicknovitski/nix-develop@v1.1.0

      - name: Setup Zig Cache
        uses: Hanaasagi/zig-action-cache@master

      - name: Compile Linux
        id: compile_linux
        continue-on-error: true
        run: zig build compile -Dtargets=linux

      - name: Compile Windows
        id: compile_windows
        continue-on-error: true
        run: zig build compile -Dtargets=windows

      - name: Compile Mac
        id: compile_mac
        continue-on-error: true
        run: zig build compile -Dtargets=mac_ub

      # IMPORTANT(upload-artifact): 
      #  1. If multiple paths are provided as input, the least common ancestor of all the search paths will be used as the 
      #     root directory of the artifact. 
      #  2. All file permissions are removed when uploading.

      - name: Upload Linux binaries
        if: steps.compile_linux.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: binaries-ubuntu
          if-no-files-found: error
          retention-days: 2
          path: |
            zig-out/x86-linux/Floe.vst3
            zig-out/x86-linux/Floe.clap
            zig-out/x86-linux/tests
            zig-out/x86-linux/VST3-Validator

      - name: Upload Mac binaries
        if: steps.compile_mac.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: binaries-macos
          if-no-files-found: error
          retention-days: 2
          path: |
            zig-out/universal-macos/Floe.vst3
            zig-out/universal-macos/Floe.clap
            zig-out/universal-macos/tests
            zig-out/universal-macos/tests.dSYM
            zig-out/universal-macos/VST3-Validator
            zig-out/universal-macos/VST3-Validator.dSYM

      - name: Upload Windows binaries
        if: steps.compile_windows.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: binaries-windows
          if-no-files-found: error
          retention-days: 2
          path: |
            zig-out/x86-windows/Floe.vst3
            zig-out/x86-windows/Floe.clap
            zig-out/x86-windows/tests.exe
            zig-out/x86-windows/VST3-Validator.exe

  test:
    strategy:
      fail-fast: false # run even if others in this matrix failed
      matrix:
        system: [
          {os: windows, log-root-dir: "C:/Users/runner/AppData/Local" },
          {os: ubuntu, log-root-dir: "/home/runner/.local/state" },
          {os: macos, log-root-dir: "/Users/runner/Library/Logs" }
        ]
        test: [ unit, vst3val, pluginval, clapval ]
    name: ${{ matrix.system.os }}-${{ matrix.test }}
    runs-on: ${{ matrix.system.os }}-latest
    needs: compile
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            test_files
            .github

      # The artifact will be installed to ${{ github.workspace }}
      - uses: actions/download-artifact@v4
        with:
          name: binaries-${{ matrix.system.os }}

      - if: matrix.system.os != 'windows'
        shell: bash
        name: ${{ matrix.test }}
        run: |
          find . 
          chmod +x ./.github/scripts/run-test.sh
          ./.github/scripts/run-test.sh ${{ matrix.test }} "${{ github.workspace }}"

      - if: matrix.system.os == 'windows'
        shell: pwsh
        name: ${{ matrix.test }}
        run: |
          tree /F 
          powershell -ExecutionPolicy Bypass -File .github\scripts\run-test.ps1 -test_type ${{ matrix.test }} -binaries_dir "${{ github.workspace }}"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: log-${{ matrix.system.os }}-${{ matrix.test }}
          if-no-files-found: ignore
          path: ${{ matrix.system.log-root-dir }}/FrozenPlain/floe.log

  static-analysis:
    strategy:
      fail-fast: false # run even if others in this matrix failed
      matrix:
        command: [ cppcheck-all, clang-tidy-all, kcov ]
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Nix Develop Action
        uses: nicknovitski/nix-develop@v1.1.0

      - name: Setup Zig Cache
        uses: Hanaasagi/zig-action-cache@master

      - name: Compile
        run: zig build compile -Dtargets=linux

      - if: matrix.command != 'kcov'
        name: Run Static Analysis
        run: ${{ matrix.command }}

      - if: matrix.command == 'kcov'
        name: Run kcov
        run: kcov kcov-output ./tests

      - if: matrix.command == 'kcov'
        name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: ./kcov-outout/tests
          verbose: true
          fail_ci_if_error: true

  reuse-compliance:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: REUSE Compliance Check
      uses: fsfe/reuse-action@v3
