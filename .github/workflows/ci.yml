# Copyright 2024 Sam Windell
# SPDX-License-Identifier: GPL-3.0-or-later

name: CI

on:
  workflow_dispatch:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  mac-compile-and-test:
    runs-on: macos-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - uses: nicknovitski/nix-develop@v1.1.0
      - uses: Hanaasagi/zig-action-cache@master
        with:
          cache-directories: |
            .zig-cache
            build_gen

      - run: just build mac_ub
      - run: just test-ci

  linux-compile-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - uses: nicknovitski/nix-develop@v1.1.0
      - uses: Hanaasagi/zig-action-cache@master
        with:
          cache-directories: |
            .zig-cache
            build_gen

      - id: compile_linux
        if: '!cancelled()'
        run: just build linux

      - id: compile_windows
        if: '!cancelled()'
        run: just build windows

      - id: compile_macos
        if: '!cancelled()'
        run: just build mac_ub

      - id: tests
        if: '!cancelled()'
        run: just test-ci

      - if: '!cancelled()'
        name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          directory: build_gen/coverage-out/tests
          verbose: true
          fail_ci_if_error: true

      # IMPORTANT(upload-artifact): 
      #  1. If multiple paths are provided as input, the least common ancestor of all the search paths will be used as the 
      #     root directory of the artifact. 
      #  2. All file permissions are removed when uploading.

      - name: Upload Windows binaries
        if: '!cancelled()'
        uses: actions/upload-artifact@v4
        with:
          name: binaries-windows
          if-no-files-found: error
          retention-days: 2
          path: |
            zig-out/x86_64-windows/Floe.vst3
            zig-out/x86_64-windows/Floe.clap
            zig-out/x86_64-windows/tests.exe
            zig-out/x86_64-windows/VST3-Validator.exe

  windows-test:
    strategy:
      fail-fast: false # run even if others in this matrix failed
      matrix:
        test: [ unit, vst3val, pluginval, clapval ]
    name: windows-${{ matrix.test }}
    runs-on: windows-latest
    needs: linux-compile-and-test
    if: '!cancelled()'
    timeout-minutes: 10
    steps:
      # The artifact will be installed to ${{ github.workspace }}
      - uses: actions/download-artifact@v4
        with:
          name: binaries-windows

      - uses: actions/checkout@v4
        with:
          sparse-checkout: |
            test_files
            .github

      - shell: pwsh
        name: ${{ matrix.test }}
        run: |
          tree /F 
          powershell -ExecutionPolicy Bypass -File .github\scripts\run-test.ps1 -test_type ${{ matrix.test }} -binaries_dir "${{ github.workspace }}"

      - name: Upload logs
        if: '!cancelled()'
        uses: actions/upload-artifact@v4
        with:
          name: log-windows-${{ matrix.test }}
          if-no-files-found: ignore
          path: C:/Users/runner/AppData/Local/Floe/floe.log

