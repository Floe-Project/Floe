# Copyright 2024 Sam Windell
# SPDX-License-Identifier: GPL-3.0-or-later

name: Release

on:
  workflow_dispatch:

jobs:
  build-windows:
    timeout-minutes: 60
    runs-on: ubuntu-latest # NOTE: we don't actually use Windows
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - uses: nicknovitski/nix-develop@v1.1.0
      - uses: Hanaasagi/zig-action-cache@master
        with:
          cache-directories: |
            .zig-cache
            build_gen

      # justfile can automatically read a .env file so this is a convenient way to pass secrets to our scripts
      - name: 'create env file'
        run: |
          touch .env
          echo "WINDOWS_CODESIGN_CERT_PFX=${{ secrets.WINDOWS_CODESIGN_CERT_PFX }}" >> .env
          echo "WINDOWS_CODESIGN_CERT_PFX_PASSWORD=${{ secrets.WINDOWS_CODESIGN_CERT_PFX_PASSWORD }}" >> .env

      - run: just build-release windows
      - run: just windows-prepare-release

      - name: 'get release dir from just'
        run: |
          export RELEASE_DIR=$(just --evaluate release_files_dir)
          echo "RELEASE_DIR=${RELEASE}" >> $GITHUB_ENV

      - uses: actions/upload-artifact@v4
        with:
          name: final-windows
          if-no-files-found: error
          path: ${{ env.RELEASE_DIR }}

  build-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - uses: DeterminateSystems/nix-installer-action@main
      - uses: DeterminateSystems/magic-nix-cache-action@main
      - uses: nicknovitski/nix-develop@v1.1.0
      - uses: Hanaasagi/zig-action-cache@master
        with:
          cache-directories: |
            .zig-cache
            build_gen

      - run: just build-release mac_arm

      - uses: apple-actions/import-codesign-certs@v3
        with: 
          p12-file-base64: ${{ secrets.MACOS_DEV_CERTS_P12 }}
          p12-password: ${{ secrets.MACOS_DEV_CERTS_P12_PASSWORD }}

      # justfile can automatically read a .env file so this is a convenient way to pass secrets to our scripts
      - name: 'create env file'
        run: |
          touch .env
          echo "MACOS_DEV_ID_INSTALLER_NAME=${{ secrets.MACOS_DEV_ID_INSTALLER_NAME }}" >> .env
          echo "MACOS_DEV_ID_APP_NAME=${{ secrets.MACOS_DEV_ID_APP_NAME }}" >> .env
          echo "MACOS_NOTARIZATION_USERNAME=${{ secrets.MACOS_NOTARIZATION_USERNAME }}" >> .env
          echo "MACOS_NOTARIZATION_PASSWORD=${{ secrets.MACOS_NOTARIZATION_PASSWORD }}" >> .env
          echo "MACOS_TEAM_ID=${{ secrets.MACOS_TEAM_ID }}" >> .env

      - run: just macos-prepare-release

      - name: 'get release dir from just'
        run: |
          export RELEASE_DIR=$(just --evaluate release_files_dir)
          echo "RELEASE_DIR=${RELEASE}" >> $GITHUB_ENV

      - uses: actions/upload-artifact@v4
        with:
          name: final-macos
          if-no-files-found: error
          path: ${{ env.RELEASE_DIR }}

  deploy:
    needs: [build-macos, build-windows]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: version.txt

      - name: 'Set Env'
        run: |
          export VERSION=$(cat version.txt)
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

          # Nice little one-liner to extract changes from the larger changelog. Thanks to QOwnNotes for this.
          # NOTE: it requires us to be consistent with our changelog format, but that's a good thing anyways.
          grep -Pzo "## ${VERSION}\n(\n|.)+?\n##" ../changelog.md | sed '$ d' >> latest_changes.md

      - uses: actions/download-artifact@v4
        with:
          pattern: final-*
          path: release_files
          merge-multiple: true

      - uses: ncipollo/release-action@v1
        with:
          artifactErrorsFailBuild: true
          artifacts: "release_files/*"
          name: Release v${{ env.VERSION }}
          tag: v${{ env.VERSION }}
          draft: true
          bodyFile: latest_changes.md

